function StartScreen(){this.width=FULLW,level.isCutscene=!0}function Level3(){this.init()}!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.SAT=b()}(this,function(){"use strict";function a(a,b){this.x=a||0,this.y=b||0}function b(b,c){this.pos=b||new a,this.r=c||0}function c(b,c){this.pos=b||new a,this.points=c||[],this.recalc()}function d(b,c,d){this.pos=b||new a,this.w=c||0,this.h=d||0}function e(){this.a=null,this.b=null,this.overlapN=new a,this.overlapV=new a,this.clear()}function f(a,b,c){for(var d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=a.length,g=0;f>g;g++){var h=a[g].dot(b);d>h&&(d=h),h>e&&(e=h)}c[0]=d,c[1]=e}function g(a,b,c,d,e,g){var h=p.pop(),i=p.pop(),j=n.pop().copy(b).sub(a),k=j.dot(e);if(f(c,e,h),f(d,e,i),i[0]+=k,i[1]+=k,h[0]>i[1]||i[0]>h[1])return n.push(j),p.push(h),p.push(i),!0;if(g){var l=0;if(h[0]<i[0])if(g.aInB=!1,h[1]<i[1])l=h[1]-i[0],g.bInA=!1;else{var m=h[1]-i[0],o=i[1]-h[0];l=o>m?m:-o}else if(g.bInA=!1,h[1]>i[1])l=h[0]-i[1],g.aInB=!1;else{var m=h[1]-i[0],o=i[1]-h[0];l=o>m?m:-o}var q=Math.abs(l);q<g.overlap&&(g.overlap=q,g.overlapN.copy(e),0>l&&g.overlapN.reverse())}return n.push(j),p.push(h),p.push(i),!1}function h(a,b){var c=a.len2(),d=b.dot(a);return 0>d?q:d>c?s:r}function i(a,b,c){var d=n.pop().copy(b.pos).sub(a.pos),e=a.r+b.r,f=e*e,g=d.len2();if(g>f)return n.push(d),!1;if(c){var h=Math.sqrt(g);c.a=a,c.b=b,c.overlap=e-h,c.overlapN.copy(d.normalize()),c.overlapV.copy(d).scale(c.overlap),c.aInB=a.r<=b.r&&h<=b.r-a.r,c.bInA=b.r<=a.r&&h<=a.r-b.r}return n.push(d),!0}function j(a,b,c){for(var d=n.pop().copy(b.pos).sub(a.pos),e=b.r,f=e*e,g=a.points,i=g.length,j=n.pop(),k=n.pop(),l=0;i>l;l++){var m=l===i-1?0:l+1,o=0===l?i-1:l-1,p=0,r=null;j.copy(a.edges[l]),k.copy(d).sub(g[l]),c&&k.len2()>f&&(c.aInB=!1);var t=h(j,k);if(t===q){j.copy(a.edges[o]);var u=n.pop().copy(d).sub(g[o]);if(t=h(j,u),t===s){var v=k.len();if(v>e)return n.push(d),n.push(j),n.push(k),n.push(u),!1;c&&(c.bInA=!1,r=k.normalize(),p=e-v)}n.push(u)}else if(t===s){if(j.copy(a.edges[m]),k.copy(d).sub(g[m]),t=h(j,k),t===q){var v=k.len();if(v>e)return n.push(d),n.push(j),n.push(k),!1;c&&(c.bInA=!1,r=k.normalize(),p=e-v)}}else{var w=j.perp().normalize(),v=k.dot(w),x=Math.abs(v);if(v>0&&x>e)return n.push(d),n.push(w),n.push(k),!1;c&&(r=w,p=e-v,(v>=0||2*e>p)&&(c.bInA=!1))}r&&c&&Math.abs(p)<Math.abs(c.overlap)&&(c.overlap=p,c.overlapN.copy(r))}return c&&(c.a=a,c.b=b,c.overlapV.copy(c.overlapN).scale(c.overlap)),n.push(d),n.push(j),n.push(k),!0}function k(a,b,c){var d=j(b,a,c);if(d&&c){var e=c.a,f=c.aInB;c.overlapN.reverse(),c.overlapV.reverse(),c.a=c.b,c.b=e,c.aInB=c.bInA,c.bInA=f}return d}function l(a,b,c){for(var d=a.points,e=d.length,f=b.points,h=f.length,i=0;e>i;i++)if(g(a.pos,b.pos,d,f,a.normals[i],c))return!1;for(var i=0;h>i;i++)if(g(a.pos,b.pos,d,f,b.normals[i],c))return!1;return c&&(c.a=a,c.b=b,c.overlapV.copy(c.overlapN).scale(c.overlap)),!0}var m={};m.Vector=a,m.V=a,a.prototype.copy=a.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this},a.prototype.perp=a.prototype.perp=function(){var a=this.x;return this.x=this.y,this.y=-a,this},a.prototype.rotate=a.prototype.rotate=function(a){var b=this.x,c=this.y;return this.x=b*Math.cos(a)-c*Math.sin(a),this.y=b*Math.sin(a)+c*Math.cos(a),this},a.prototype.reverse=a.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},a.prototype.normalize=a.prototype.normalize=function(){var a=this.len();return a>0&&(this.x=this.x/a,this.y=this.y/a),this},a.prototype.add=a.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this},a.prototype.sub=a.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this},a.prototype.scale=a.prototype.scale=function(a,b){return this.x*=a,this.y*=b||a,this},a.prototype.project=a.prototype.project=function(a){var b=this.dot(a)/a.len2();return this.x=b*a.x,this.y=b*a.y,this},a.prototype.projectN=a.prototype.projectN=function(a){var b=this.dot(a);return this.x=b*a.x,this.y=b*a.y,this},a.prototype.reflect=a.prototype.reflect=function(a){var b=this.x,c=this.y;return this.project(a).scale(2),this.x-=b,this.y-=c,this},a.prototype.reflectN=a.prototype.reflectN=function(a){var b=this.x,c=this.y;return this.projectN(a).scale(2),this.x-=b,this.y-=c,this},a.prototype.dot=a.prototype.dot=function(a){return this.x*a.x+this.y*a.y},a.prototype.len2=a.prototype.len2=function(){return this.dot(this)},a.prototype.len=a.prototype.len=function(){return Math.sqrt(this.len2())},m.Circle=b,m.Polygon=c,c.prototype.recalc=c.prototype.recalc=function(){this.edges=[],this.normals=[];for(var b=this.points,c=b.length,d=0;c>d;d++){var e=b[d],f=c-1>d?b[d+1]:b[0],g=(new a).copy(f).sub(e),h=(new a).copy(g).perp().normalize();this.edges.push(g),this.normals.push(h)}return this},c.prototype.rotate=c.prototype.rotate=function(a){var b,c=this.points,d=this.edges,e=this.normals,f=c.length;for(b=0;f>b;b++)c[b].rotate(a),d[b].rotate(a),e[b].rotate(a);return this},c.prototype.translate=c.prototype.translate=function(a,b){var c,d=this.points,e=d.length;for(c=0;e>c;c++)d[c].x+=a,d[c].y+=b;return this},m.Box=d,d.prototype.toPolygon=d.prototype.toPolygon=function(){var b=this.pos,d=this.w,e=this.h;return new c(new a(b.x,b.y),[new a,new a(d,0),new a(d,e),new a(0,e)])},m.Response=e,e.prototype.clear=e.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var n=[],o=0;10>o;o++)n.push(new a);for(var p=[],o=0;5>o;o++)p.push([]);var q=-1,r=0,s=1;return m.testCircleCircle=i,m.testPolygonCircle=j,m.testCirclePolygon=k,m.testPolygonPolygon=l,m});var utils=function(){var a;return{extend:function(a,b){$.extend(a,b);var c="imgReady";Object.defineProperty(a,c,{get:function(){return b[c]}})},speed2scale:function(a){return-.5*a+2},randF:function(a,b,c){return"undefined"==typeof c&&(c=2),parseFloat(Math.min(a+Math.random()*(b-a),b).toFixed(c))},repeatAction:function(a,b,c){var d=0,e=setInterval(function(){d++>b?clearInterval(e):c()},a)},deathSequence:function(){game.over||(game.over=!0,audio.heroDeath.play(),audio.bgMusic.muted=!0,setTimeout(function(){Graphics.fadeCanvas(function(){hero.lives-1<0?(alert("You Lose"),location.reload()):--hero.lives,level.reset(),level.curLvl.deinit(),level.curLvl.init(),audio.isOn&&(audio.bgMusic.muted=!1)})},2600))},degToRad:function(a){return.017453292519943295*a},revFactorial:function(a){for(var b=2,c=a;1!==c;){if(console.log(c+"/"+b+"="),c/=b,0===c)return-1;if(1===c)return b;++b}},getTimeObj:function(a){if(0===a)return{min:"00",sec:"00"};var b=Math.floor(a/60),c=a%60;return 10>c&&(c="0"+c),10>b&&(b="0"+b),{min:b,sec:c}},browser:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+(\.\d+)?)/g.exec(b)||[],"IE "+(a[1]||"")):(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/([\.\d]+)/i))&&(c[2]=a[1]),c.join(" "))},printSlow:function(a){game.actualTime%10===0&&console.log(a)},printMouse:function(){$("canvas").on("mousemove",function(a){console.log(a.offsetX,a.offsetY)})},printDir:function(a){switch(a){case 0:console.log("Dir.NONE");break;case 1:console.log("Dir.TOP");break;case 2:console.log("Dir.BOT");break;case 3:console.log("Dir.LEFT");break;case 4:console.log("Dir.RIGHT");break;case 5:console.log("Dir.IN");break;default:console.log("Dir.unknown")}},toggleMenu:function(){"block"===$("#colorbox").css("display")?a.colorbox.close():a=$.colorbox({html:$(".gameInstructions").html(),width:320,height:530})},toggleFullScreen:function(){if($("body").hasClass("fullscreen"))$(".canvasWrap").css({width:"",marginLeft:""}),$("body").removeClass("fullscreen");else{$("body").addClass("fullscreen");var a=1.777778*$(window).height();$(".canvasWrap").css({width:a,marginLeft:-a/2})}}}}(),Dir=Object.freeze({NONE:0,TOP:1,BOT:2,LEFT:3,RIGHT:4,IN:5,UP:6,DOWN:7,UP_RIGHT:8,DOWN_RIGHT:9}),Color=Object.freeze({LIGHT_BROWN:"#c44525",DARK_BROWN:"#672819",LIGHT_GREEN:"#166a38",SILVER:"#c0c0c0",BLACK:"#000",GOLD:"#ddaa13",ORANGE:"#ff6a00"});window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,16.6666666667)}}();var audio=function(){return{bgMusic:new Audio("audio/firstChiptune/firstChiptune.mp3"),enterSound:new Audio("audio/synthetic_explosion_1.mp3"),exitSound:new Audio("audio/annulet.mp3"),itemPickedUp:new Audio("audio/life_pickup.mp3"),heartbeat:new Audio("audio/heartbeat.mp3"),jump:new Audio("audio/jump.mp3"),thud:new Audio("audio/thud.mp3"),step:new Audio("audio/step.mp3"),effort:new Audio("audio/woosh.mp3"),discovery:new Audio("audio/spell3.mp3"),enemyDeath:new Audio("audio/death.mp3"),heroDeath:new Audio("audio/DiscsOfTron_Cascade.mp3"),enchant:new Audio("audio/enchant.mp3"),isOn:!1,init:function(){audio.bgMusic.loop=!0,audio.bgMusic.volume=.7,audio.bgMusic.pause(),audio.enemyDeath.volume=.6,audio.jump.volume=.4,audio.thud.volume=.78,audio.discovery.volume=.7,audio.mute(!0),$(document).on("click",".audioState",audio.handleMuteButton),$(".menu").on("click",function(a){a.preventDefault(),utils.toggleMenu()}),audio.handleMuteButton()},lvlComplete:function(){audio.bgMusic.pause();var a;switch(game.lvl){case 0:audio.enterSound.play(),a="inspiredBySparkMan/sparkBoy.mp3";break;default:audio.exitSound.play(),a="sweetAcoustic.mp3"}setTimeout(function(){audio.bgMusic=new Audio("audio/"+a),audio.bgMusic.loop=!0,audio.bgMusic.volume=.45,audio.isOn?audio.bgMusic.play():audio.bgMusic.pause()},1e3)},play:function(a,b){b="undefined"!=typeof b?b:!0,a.ended?a.play():(b||0===a.currentTime)&&(a.pause(),a.currentTime=0,a.play())},handleMuteButton:function(){$(".audioState").hasClass("off")?($(".audioState span").removeClass("icon-volume-mute").addClass("icon-volume-medium"),$(".audioState").removeClass("off"),$(".audioState").addClass("on"),audio.mute(!1)):($(".audioState span").removeClass("icon-volume-medium").addClass("icon-volume-mute"),$(".audioState").removeClass("on"),$(".audioState").addClass("off"),audio.mute(!0))},mute:function(a){audio.discovery.muted=audio.enterSound.muted=audio.bgMusic.muted=audio.itemPickedUp.muted=audio.heartbeat.muted=audio.effort.muted=audio.thud.muted=audio.jump.muted=audio.step.muted=audio.enemyDeath.muted=audio.heroDeath.muted=audio.enchant.muted=audio.exitSound.muted=a,a?audio.bgMusic.pause():audio.bgMusic.play(),audio.isOn=!a}}}(),Graphics=function(){var a=1,b=null,c=250,d=c,e=c,f=170;return{ticker:1,tickerStep:.01,fadeOut:!1,projectX:8,projectY:11,fadeCanvas:function(a){"MSIE 9.0"===utils.browser()?a():($(canvas).removeClass("preTransition"),$(canvas).addClass("duringTransition"),b=$(canvas).on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){b.off(),$(this).removeClass("duringTransition"),$(this).addClass("preTransition"),a()}))},blinkText:function(b,c,d,e){e="undefined"!=typeof e?e:"PRESS ENTER",(Graphics.ticker>=1.35||Graphics.ticker<=Graphics.tickerStep)&&(Graphics.fadeOut=!Graphics.fadeOut),a=Graphics.ticker>=1?1:Graphics.ticker<=Graphics.tickerStep?0:Graphics.ticker,ctx.font=b+"px 'Press Start 2P'";var f=ctx.measureText(e).width;ctx.fillStyle="rgba(233, 233, 233,"+a+")",ctx.fillText(e,c-f/2,d)},getSkewedRect:function(a,b,c,d){b+=Graphics.projectY/2;var e=new SAT.Polygon(new SAT.Vector(a,b),[new SAT.Vector,new SAT.Vector(c-Graphics.projectX,0),new SAT.Vector(c,Graphics.projectY),new SAT.Vector(c,d),new SAT.Vector(Graphics.projectX,d),new SAT.Vector(0,d-Graphics.projectY)]);return e},getStairPoly:function(a,b,c,d,e){var f;return f=e===Dir.UP_RIGHT?new SAT.Polygon(new SAT.Vector(a,b),[new SAT.Vector,new SAT.Vector(c-Graphics.projectX,-d),new SAT.Vector(c,-d+Graphics.projectY),new SAT.Vector(c,0),new SAT.Vector(Graphics.projectX,d),new SAT.Vector(0,d-Graphics.projectY)]):new SAT.Polygon(new SAT.Vector(a,b),[new SAT.Vector,new SAT.Vector(c-Graphics.projectX,d-Graphics.projectY-5),new SAT.Vector(c,d-4),new SAT.Vector(0,d),new SAT.Vector(Graphics.projectX,d),new SAT.Vector(0,d-Graphics.projectY)])},setClouds:function(a){for(var b=0;a>b;)b=Graphics.spawnCloud(b)},spawnCloud:function(a){var b=Math.floor(Math.random()*f),c=utils.randF(2,3.3,1),d=120*utils.speed2scale(c);a+=d+Math.floor(20*Math.random()+8);var e=new GameObj(JQObject.CLOUD,a,10+b,0,0,"cloud.png");return e.speed=c,e.distTraveled=0,e.distToTravel=a+d,level.bg.push(e),a},drawLadder:function(a){var b=a.pos.x,c=a.pos.y,d=a.edges[0].x,e=a.edges[1].y;ctx.fillStyle=Color.LIGHT_BROWN,ctx.fillRect(b,c,5,e),ctx.fillRect(b+d-5,c,5,e);for(var f=13;e>f;f+=20)ctx.fillRect(b,c+f,d,8)},getScale:function(a,b){for(var c={},d=0;2>d;++d){var e=0===d?Dir.LEFT:Dir.RIGHT;c[e]=new GameObj(JQObject.SCALE,a+300*d,b,150,46),c[e].holdingItem=null}return c.vBar=new GameObj(JQObject.SCALEBG,c[Dir.LEFT].pos.x+c[Dir.LEFT].w+70,HALFH-game.padFloor,10,HALFH),c.vBar.collidable=!1,c.hBar=new GameObj(JQObject.SCALEBG,c[Dir.LEFT].pos.x+c[Dir.LEFT].w/2,HALFH,300,10),c.hBar.x2=c.hBar.pos.x+c.hBar.w,c.hBar.y2=c.hBar.pos.y,c.hBar.collidable=!1,c.hBar.visible=!1,c[Dir.LEFT].hBar=c.hBar,c[Dir.LEFT].side=Dir.LEFT,c[Dir.LEFT].otherSide=c[Dir.RIGHT],c[Dir.RIGHT].hBar=c.hBar,c[Dir.RIGHT].side=Dir.RIGHT,c[Dir.RIGHT].otherSide=c[Dir.LEFT],c},drawScale:function(a){var b=a.pos.x,c=a.pos.y,d=a.edges[0].x,e=a.edges[1].y;ctx.fillStyle=Color.BLACK,ctx.fillRect(b,c-1,d,1),ctx.fillStyle=Color.DARK_BROWN,ctx.fillRect(b,c,d,e)},drawScaleChains:function(a,b,c){ctx.beginPath(),ctx.moveTo(a,b),ctx.lineTo(c.pos.x,c.pos.y),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(a,b),ctx.lineTo(c.pos.x+c.w/2,c.pos.y),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(a,b),ctx.lineTo(c.pos.x+c.w,c.pos.y),ctx.stroke(),ctx.closePath()},drawScaleBg:function(a){ctx.strokeStyle="#000",ctx.lineWidth=10,ctx.beginPath(),ctx.moveTo(a.hBar.pos.x,a.hBar.pos.y),ctx.lineTo(a.hBar.x2,a.hBar.y2),ctx.stroke(),ctx.closePath(),Graphics.drawScaleChains(a.hBar.pos.x,a.hBar.pos.y,a[Dir.LEFT]),Graphics.drawScaleChains(a.hBar.x2,a.hBar.y2,a[Dir.RIGHT])},drawPoly:function(a,b,c){var d=a.pos.y-Graphics.projectY,e=a.pos.x;"undefined"!=typeof c&&(e+=c.x,d+=c.y),ctx.fillStyle="undefined"!=typeof b?b:"orange",ctx.beginPath(),ctx.moveTo(e,d);for(var f=1;f<a.points.length;++f)ctx.lineTo(e+a.points[f].x,d+a.points[f].y);ctx.closePath(),ctx.fill()},drawHill:function(a){for(var b=0;b<game.padFloor-15;++b)Graphics.drawPoly(a,Color.LIGHT_BROWN,{x:0,y:b});Graphics.drawPoly(a,Color.DARK_BROWN,{x:Graphics.projectX,y:game.padFloor})},getHill:function(a,b,c,d){var e=[new SAT.V];a+=c/2,b+=Graphics.projectY;for(var f,g,h=c/2,i=d/2,j=180;360!==j;)f=h*Math.cos(utils.degToRad(j)),g=i*Math.sin(utils.degToRad(j++)),e.push(new SAT.V(f,g));return e.push(new SAT.V(c/2)),new SAT.Polygon(new SAT.V(a,b),e)},drawPlatform:function(a){var b=a.pos.y-Graphics.projectY/2;ctx.fillStyle=Color.LIGHT_BROWN,ctx.beginPath(),ctx.moveTo(a.pos.x,b),ctx.lineTo(a.pos.x+a.points[1].x,b+a.points[1].y),ctx.lineTo(a.pos.x+a.points[2].x,b+a.points[2].y),ctx.lineTo(a.pos.x+Graphics.projectX,b+Graphics.projectY),ctx.closePath(),ctx.fill(),ctx.fillStyle=Color.DARK_BROWN,ctx.beginPath(),ctx.moveTo(a.pos.x+a.points[2].x,b+a.points[2].y),ctx.lineTo(a.pos.x+a.points[3].x,b+a.points[3].y),ctx.lineTo(a.pos.x+a.points[4].x,b+a.points[4].y),ctx.lineTo(a.pos.x+a.points[5].x,b+a.points[5].y),ctx.lineTo(a.pos.x+a.points[0].x,b+a.points[0].y),ctx.lineTo(a.pos.x+Graphics.projectX,b+Graphics.projectY),ctx.closePath(),ctx.fill()},drawPlatformStatus:function(a){var b=a.pos.x,c=a.pos.y,d=a.w,e=a.h,f=26,g=f/2,h=b+d/2-g,i=c+e/2-g;ctx.lineWidth=3,null!==a.holdingItem&&a.holdingItem.type===JQObject.CRATE?(ctx.strokeStyle="green",--i,ctx.beginPath(),ctx.moveTo(h,i+g),ctx.lineTo(h+g,i+f),ctx.moveTo(h+g-1,i+f),ctx.lineTo(h+f+2,i+2),ctx.stroke(),ctx.closePath()):(ctx.strokeStyle="red",ctx.beginPath(),ctx.moveTo(h,i),ctx.lineTo(h+f,i+f),ctx.moveTo(h,i+f),ctx.lineTo(h+f,i),ctx.stroke(),ctx.closePath())},drawDoor:function(a){var b=a.pos.x,c=a.pos.y,d=a.w,e=a.h;ctx.fillStyle=Color.LIGHT_BROWN,ctx.fillRect(b+2,c+2,d-2,e-2),ctx.fillStyle=Color.DARK_BROWN,ctx.fillRect(b,c,2,e),ctx.fillRect(b,c,d,2),ctx.fillRect(b+d,c,2,e),ctx.beginPath(),ctx.arc(b+d-d/3.2,c+e-e/3.4,4,0,2*Math.PI,!1),ctx.fill(),ctx.closePath(),ctx.font="19px 'Press Start 2P'",ctx.fillStyle=Color.DARK_BROWN,ctx.fillText("EXIT",b-15,c-3),ctx.fillStyle=Color.LIGHT_BROWN,ctx.fillText("EXIT",b-18,c-5)},getDoorBgGrad:function(){var a=ctx.createRadialGradient(level.bgColor.gradX,level.bgColor.gradY,14,level.bgColor.gradX,level.bgColor.gradY,490-e);return--d===-c?(d=c,e=c):0>d?++e:--e,a.addColorStop(0,"rgb(203,163,0)"),a.addColorStop(1,"#1F7DCF"),a},drawEllipse:function(a,b,c,d){var e=.5522848,f=c/2*e,g=d/2*e,h=a+c,i=b+d,j=a+c/2,k=b+d/2;ctx.beginPath(),ctx.moveTo(a,k),ctx.bezierCurveTo(a,k-g,j-f,b,j,b),ctx.bezierCurveTo(j+f,b,h,k-g,h,k),ctx.bezierCurveTo(h,k+g,j+f,i,j,i),ctx.bezierCurveTo(j-f,i,a,k+g,a,k),ctx.closePath(),ctx.fill()},drawRotate:function(a,b,c,d){ctx.save(),ctx.translate(b,c),ctx.rotate(utils.degToRad(d)),ctx.translate(.5*-a.width,.5*-a.height),ctx.drawImage(a,0,0),ctx.restore()}}}(),Physics=function(){return{isCollision:function(a,b,c,d){var e="undefined"!=typeof d?a.pos.x+a.lvlX:a.pos.x;return e+c<=b.pos.x+b.w&&b.pos.x+c<=e+a.w&&a.pos.y+c<=b.pos.y+b.h&&b.pos.y+c<=a.pos.y+a.h?!0:!1},isSATcollision:function(a,b,c){var d=new SAT.Response;SAT.testPolygonPolygon(a,b,d)&&c(d)},testObjObjs:function(a,b){for(var c=new SAT.Response,d=0;d<level.objs.length;++d){var e=level.objs[d];if("undefined"==typeof e.collidable){var f=SAT.testPolygonPolygon(a,e,c);f&&b(c),c.clear()}}},testItemItems:function(a,b){for(var c=new SAT.Response,d=0;d<level.items.length;++d)if(!level.items[d].isBeingHeld){if(level.items[d].type!==JQObject.CRATE)continue;var e=SAT.testPolygonPolygon(a,level.items[d],c);if(e&&1===c.overlapN.y){c.a.pos.x-=c.overlapV.x,c.a.pos.y-=c.overlapV.y,b(c);break}c.clear()}},testHeroItems:function(a){for(var b=0;b<level.items.length;++b)level.items[b].visible&&Physics.isSATcollision(hero,level.items[b],function(c){a(c,b)})},handleScale:function(){for(var a=0,b=0;b<level.objs.length;++b)level.objs[b].type===JQObject.SCALE&&"undefined"!=typeof level.objs[b].holdingItem&&null!==level.objs[b].holdingItem&&level.objs[b].holdingItem.type===JQObject.CRATE&&++a;var c=2===a;if(c){audio.discovery.play();var d=$.grep(level.objs,function(a){return a.type===JQObject.LADDER});d[0].visible=!0}return c}}}(),JQObject=Object.freeze({EMPTY:0,CRATE:1,LADDER:2,SACK:3,ENEMY:4,CASH:5,DOOR:6,SCALE:7,CLOUD:8,PLATFORM:9,SHURIKEN:10,SLOPE:11,POLY:12,HILL:13,ELEVATOR:14,SCALEBG:15,FIREBALL:16}),JQObject_names=Object.freeze({0:"EMPTY",1:"CRATE",2:"LADDER",3:"SACK",4:"ENEMY",5:"CASH",6:"DOOR",7:"SCALE",8:"CLOUD",9:"PLATFORM",10:"SHURIKEN",11:"SLOPE",12:"POLY",13:"HILL",14:"ELEVATOR",15:"SCALEBG",16:"FIREBALL"}),GameObj=function(a,b,c,d,e,f,g){if(this.dir=g,a===JQObject.PLATFORM||a===JQObject.ELEVATOR?$.extend(this,Graphics.getSkewedRect(b,c,d,e)):a===JQObject.SLOPE?$.extend(this,Graphics.getStairPoly(b,c,d,e,g)):a===JQObject.HILL?$.extend(this,Graphics.getHill(b,c,d,e)):a===JQObject.POLY||$.extend(this,new SAT.Box(new SAT.Vector(b,c),d,e).toPolygon()),this.type=a,this.imgReady=!1,"undefined"==typeof f||null===f)this.w=d,this.h=e;else{this.w=d,this.h=e,this.img=new Image;var h=this;this.img.onload=function(){h.imgReady=!0,h.w=this.width,h.h=this.height},this.img.src="img/"+f}};GameObj.prototype={draw:function(){this.imgReady?ctx.drawImage(this.img,this.pos.x,this.pos.y):(ctx.fillStyle=this.type===JQObject.SCALEBG?Color.LIGHT_BROWN:this.type===JQObject.FIREBALL?"orange":"red",ctx.fillRect(this.pos.x,this.pos.y,this.w,this.h))}};var GameItem=function(a,b,c,d){utils.extend(this,a),this.grabbable="undefined"!=typeof b?b:!1,this.val="undefined"!=typeof c?c:-1,this.visible="undefined"!=typeof d?d:!0,this.vY=0,this.isOnObj=!1,this.onObj=null,this.isBeingHeld=!1;var e=this.draw;this.draw=function(){this.visible&&e.apply(this)}},HUD=function(){function a(){for(var a=0;a<hero.health;++a)ctx.fillStyle="red",ctx.fillRect(77+21*a,FULLH+8,19,8)}function b(){for(var a=0;a<hero.mana;++a)ctx.fillStyle="#00b6ff",ctx.fillRect(77+21*a,FULLH+26,19,8)}function c(){ctx.fillStyle="#ddd",ctx.font="12px 'Press Start 2P'";var a=hero.xp<10?"0":"";ctx.fillText(a+hero.xp+"/"+hero.xpNeeded,77,FULLH+54)}var d=null,e=null,f=null,g=null;return{init:function(){d=new GameObj(JQObject.EMPTY,548,FULLH+20,22,24,"cash.png"),e=new GameObj(JQObject.EMPTY,238,FULLH+15,31,30,"medKit.png"),f=new GameObj(JQObject.EMPTY,447,FULLH+15,31,31,"shuriken.png"),g=new GameObj(JQObject.EMPTY,342,FULLH+18,25,25,"syringe.png")},draw:function(){ctx.fillStyle="#070707",ctx.fillRect(0,FULLH,FULLW,game.padHUD),ctx.fillStyle="#ddd",ctx.font="11px 'Press Start 2P'",ctx.fillText("HP-"+hero.healthLvl,7,FULLH+18),ctx.fillText("MP-"+hero.manaLvl,7,FULLH+37),ctx.fillText("XP",7,FULLH+54),a(),b(),c(),ctx.fillText(hero.medKits,210,FULLH+37),e.draw(),ctx.fillText(hero.manaKits,315,FULLH+37),g.draw(),ctx.fillText(hero.ammo,410,FULLH+37),f.draw(),ctx.fillText(hero.cash,515,FULLH+37),d.draw(),ctx.fillText("LIVES x"+hero.lives,700,FULLH+37);var h=utils.getTimeObj(game.actualTime);ctx.fillText(h.min+":"+h.sec,FULLW-78,FULLH+24)}}}(),JQEnemy=Object.freeze({STILL:0,PATROL:1,FOLLOW:2}),Enemy=function(a,b,c,d,e,f){function g(){var a=h.w/h.initHealth*h.health;ctx.fillStyle="red",ctx.fillRect(h.pos.x,h.pos.y-12,a,4)}utils.extend(this,a),this.initX=this.pos.x,this.initY=this.pos.y,this.initHealth=this.health=c,this.enemy_t=b,this.leftXBound=d,this.rightXBound=e,this.active="undefined"!=typeof f?f:!1,this.deadOffScreen=!1,this.dir=Dir.RIGHT,this.alive=!0,this.deadOnScreen=!1,this.clearDir=Dir.RIGHT;var h=this,i=this.draw;this.draw=function(){(this.alive||this.deadOnScreen)&&(this.initHealth>1&&g(),ctx.save(),this.deadOnScreen&&(ctx.globalAlpha=.3),i.apply(this),ctx.restore())}};Enemy.prototype={update:function(){this.deadOnScreen?this.enemy_t===JQEnemy.STILL?(this.deadOnScreen=!1,this.deadOffScreen=!0):(this.pos.x+=this.clearDir===Dir.RIGHT?2:-2,this.pos.y-=9,(this.pos.x<0||this.pos.x>FULLW)&&(this.deadOnScreen=!1,this.deadOffScreen=!0)):this.active&&game.totalTicks%3===0&&this.movement()},movement:function(){this.enemy_t===JQEnemy.PATROL?(this.pos.x+hero.lvlX<=this.leftXBound?this.dir=Dir.RIGHT:this.pos.x+hero.lvlX>=this.rightXBound&&(this.dir=Dir.LEFT),this.dir===Dir.RIGHT?++this.pos.x:--this.pos.x):this.enemy_t===JQEnemy.FOLLOW&&(this.pos.x<hero.pos.x?++this.pos.x:this.pos.x>hero.pos.x&&--this.pos.x)},death:function(){this.clearDir=hero.dir,audio.enemyDeath.play(),hero.xp+=15,this.alive=!1,this.deadOnScreen=!0},revive:function(){this.health=this.initHealth,this.deadOffScreen=!1,this.deadOnScreen=!1,this.alive=!0}};var level=function(){function a(){for(var a=0;a<level.objs.length;++a)level.objs[a].pos.x-=hero.vX,level.objs[a].type===JQObject.SCALEBG&&(level.objs[a].x2-=hero.vX)}function b(){for(var a=0;a<level.items.length;++a)level.items[a].pos.x-=hero.vX}function c(){level.bgColor.gradX-=hero.vX,level.bgColor.fillStyle=Graphics.getDoorBgGrad();for(var a=0;a<level.bg.length;++a){var b=hero.vX/level.bg[a].speed;level.bg[a].pos.x-=b,level.bg[a].distTraveled+=b}}function d(){for(var a=0;a<level.enemies.length;++a)level.enemies[a].pos.x-=hero.vX}function e(){for(var a=0;a<level.items.length;++a)level.items[a].visible&&!level.items[a].isOnObj&&(level.items[a].vY<k?level.items[a].vY+=game.gravity:level.items[a].vY=k,Physics.testObjObjs(level.items[a],function(a){a.a.pos.x-=a.overlapV.x,a.a.pos.y-=a.overlapV.y,1===a.overlapN.y&&(audio.thud.play(),a.a.vY=a.b.type===JQObject.ELEVATOR?a.b.vY:0,a.a.isOnObj=!0,a.a.onObj=a.b,a.a.recentlyHeld=!1,a.b.type===JQObject.SCALE&&null===a.b.holdingItem&&(a.a.grabbable=!1,a.b.holdingItem=a.a,utils.repeatAction(42,14,function(){a.b.side===Dir.LEFT?(++a.a.pos.y,++a.b.pos.y,++a.b.hBar.pos.y,--a.b.otherSide.pos.y,--a.b.hBar.y2,null!==a.b.otherSide.holdingItem&&--a.b.otherSide.holdingItem.pos.y):(++a.a.pos.y,++a.b.pos.y,++a.b.hBar.y2,--a.b.hBar.pos.y,--a.b.otherSide.pos.y,null!==a.b.otherSide.holdingItem&&--a.b.otherSide.holdingItem.pos.y)})))}),Physics.testItemItems(level.items[a],function(a){a.a.isOnObj=!0,a.a.onObj=a.b,a.b.grabbable=!1,a.a.recentlyHeld=!1})),"undefined"!=typeof level.items[a].onObj&&null!==level.items[a].onObj&&(level.items[a].vY=level.items[a].onObj.type===JQObject.ELEVATOR?level.items[a].onObj.vY:0),level.items[a].pos.y+=level.items[a].vY}function f(){for(var a=0;a<level.enemies.length;++a)if(level.enemies[a].update(),level.enemies[a].health>0){SAT.testPolygonPolygon(hero,level.enemies[a])&&(level.enemies[a].active=!0,hero.invincible||(audio.play(audio.heartbeat,!0),hero.invincible=!0,--hero.health));for(var b=0;b<hero.bulletArr.length;++b)SAT.testPolygonPolygon(hero.bulletArr[b],level.enemies[a])&&(audio.play(audio.thud,!0),level.enemies[a].active=!0,hero.bulletArr.splice(b,1),--level.enemies[a].health,level.enemies[a].health<=0&&level.enemies[a].death())}}function g(){ctx.fillStyle="#000",ctx.fillRect(0,FULLH-game.padFloor,FULLW,game.padFloor),ctx.fillStyle=level.bgColor.fillStyle,ctx.fillRect(0,0,FULLW,FULLH-game.padFloor);for(var a=0;a<level.bg.length;++a){var b=level.bg[a],c=utils.speed2scale(b.speed);ctx.drawImage(b.img,b.pos.x,b.pos.y,b.w*c,b.h*c)}}function h(){for(var a=0;a<level.objs.length;++a){var b=level.objs[a];("undefined"==typeof b.visible||b.visible)&&(b.type===JQObject.LADDER?Graphics.drawLadder(b):b.type===JQObject.SCALE?(Graphics.drawScale(b),Graphics.drawPlatformStatus(b)):b.type===JQObject.PLATFORM||b.type===JQObject.SLOPE||b.type===JQObject.ELEVATOR?Graphics.drawPlatform(b):b.type===JQObject.DOOR?Graphics.drawDoor(b):b.type===JQObject.POLY?Graphics.drawPoly(b):b.type===JQObject.HILL?Graphics.drawHill(b):b.draw())}}function i(){for(var a=0;a<level.items.length;++a)level.items[a].draw()}function j(){for(var a=0;a<level.enemies.length;++a)level.enemies[a].deadOffScreen||level.enemies[a].draw()}var k=10;return{bgColor:{},bg:[],objs:[],items:[],enemies:[],curLvl:null,isCutscene:!1,time:0,hiddenItemsFound:0,hiddenItems:0,isTransitioning:!1,init:function(){level.reset(),level.curLvl=new StartScreen},reset:function(){game.over=!1,game.actualTime=0,level.hiddenItemsFound=0,hero.lvlX=0,level.bgColor={fillStyle:"#000"},level.bg=[],level.objs=[],level.items=[],level.enemies=[],hero.pos.x=23,hero.pos.y=FULLH-game.padFloor-hero.h+4,hero.vX=hero.vY=0,hero.isJumping=!1,hero.ammo=20,hero.bulletArr.length=0,hero.invincible=!1,hero.isHolding=!1,hero.curItem=null,hero.dir=Dir.RIGHT,hero.health=hero.maxHealth},complete:function(){level.isTransitioning=!0,audio.lvlComplete(),Graphics.ticker=1,Graphics.fadeOut=!0,Graphics.fadeCanvas(function(){level.isTransitioning=!1,level.curLvl=lvlComplete,level.isCutscene=!0,level.time=game.actualTime})},update:function(){if(!level.isTransitioning){if(0!=game.lvl){e(),f();for(var a=level.bg.length;a--;){var b=.5/level.bg[a].speed;level.bg[a].pos.x-=b,level.bg[a].distTraveled+=b,level.bg[a].distTraveled>level.bg[a].distToTravel&&(level.bg.splice(a,1),Graphics.spawnCloud(level.curLvl.width))}}level.curLvl.update()}},updateView:function(){a(),b(),c(),d()},render:function(){g(),h(),i(),j(),level.curLvl.render()}}}(),lvlComplete=function(){return{update:function(){if(keysDown[KeyCode.ENTER]||0===game.lvl||window.DEBUG&&1===game.lvl){switch(lastKeyDown=KeyCode.EMPTY,level.reset(),++game.lvl){case 1:lvl1.init(),level.curLvl=lvl1;break;case 2:lvl2.init(),level.curLvl=lvl2;break;case 3:var a=new Level3;level.curLvl=a}level.isCutscene=!1}},render:function(){ctx.fillStyle="#000",ctx.fillRect(0,0,FULLW,canvas.height),ctx.font="24px 'Press Start 2P'";var a="LEVEL "+game.lvl+" COMPLETE",b=ctx.measureText(a).width;ctx.fillStyle=Color.ORANGE,ctx.fillText(a,HALFW-b/2,70),ctx.font="18px 'Press Start 2P'";{var c=utils.getTimeObj(level.time),d="LEVEL TIME......"+c.min+":"+c.sec;ctx.measureText(d).width}ctx.fillStyle="#e1e1e1",ctx.fillText(d,HALFW-b/2,150),ctx.font="18px 'Press Start 2P'";var e="HIDDEN ITEMS....."+level.hiddenItemsFound+"/"+level.hiddenItems,f=ctx.measureText(e).width;ctx.fillStyle="#e1e1e1",ctx.fillText(e,HALFW-f/2,190),Graphics.blinkText(16,HALFW,HALFH+120)}}}();StartScreen.prototype=function(){var a="JON'S",b="QUEST",c=String.fromCharCode("169")+" 2014 JON WIEDMANN";return{update:function(){lastKeyDown===KeyCode.ENTER&&level.complete()},render:function(){ctx.font="29px 'Press Start 2P'";var d=HALFW-ctx.measureText(a).width/2+11,e=58;ctx.setTransform(1,0,-.4,1.4,0,0),ctx.fillStyle="#222",ctx.fillText("J",d+4,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("J",d,e),ctx.setTransform(1,0,-.2,1.4,0,0),ctx.fillStyle="#222",ctx.fillText("O",d+32,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("O",d+28,e),ctx.setTransform(1,0,.05,1.41,0,-1),ctx.fillStyle="#222",ctx.fillText("N",d+58,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("N",d+54,e),ctx.setTransform(1,0,.23,1.4,0,0),ctx.fillStyle="#222",ctx.fillText("'",d+78,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("'",d+74,e),ctx.setTransform(1,0,.42,1.4,0,0),ctx.fillStyle="#222",ctx.fillText("S",d+95,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("S",d+91,e),ctx.font="36px 'Press Start 2P'",d=HALFW-ctx.measureText(b).width/2+30,e=98,ctx.setTransform(1,0,-.5,1.6,0,0),ctx.fillStyle="#222",ctx.fillText("Q",d+4,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("Q",d,e),ctx.setTransform(1,0,-.25,1.6,0,0),ctx.fillStyle="#222",ctx.fillText("U",d+26,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("U",d+22,e),ctx.setTransform(1,0,.03,1.6,0,0),ctx.fillStyle="#222",ctx.fillText("E",d+50,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("E",d+46,e),ctx.setTransform(1,0,.25,1.6,0,0),ctx.fillStyle="#222",ctx.fillText("S",d+74,e+3),ctx.fillStyle="#ff6a00",ctx.fillText("S",d+70,e),ctx.setTransform(1,0,.5,1.6,0,0),ctx.fillStyle="#222",ctx.fillText("T",d+90,e+4),ctx.fillStyle="#ff6a00",ctx.fillText("T",d+86,e),ctx.setTransform(1,0,0,1,0,0),Graphics.blinkText(22,HALFW,HALFH+81),ctx.fillStyle="#000",ctx.fillRect(0,FULLH,FULLW,game.padHUD),ctx.font="13px 'Press Start 2P'",ctx.fillStyle="#c9c9c9",ctx.fillText(c,HALFW-ctx.measureText(c).width/2,FULLH+24)}}}();var lvl1=function(){function a(){level.bgColor.gradX=f.pos.x+f.w/2,level.bgColor.gradY=f.pos.y+f.h/2,level.bgColor.fillStyle=Graphics.getDoorBgGrad(),Graphics.setClouds(lvl1.width)}function b(){level.objs.push(new GameObj(JQObject.PLATFORM,-Graphics.projectX,FULLH-game.padFloor-1,lvl1.width+2*Graphics.projectX,game.padFloor+1),new GameObj(JQObject.PLATFORM,200,206,267,62),new GameObj(JQObject.PLATFORM,575,310,300,62),new GameObj(JQObject.PLATFORM,605,125,220,62)),i=Graphics.getScale(1500,FULLH-game.padFloor-137),level.objs.push(i.vBar,i.hBar,i[Dir.LEFT],i[Dir.RIGHT]);var a=new GameObj(JQObject.SLOPE,2203,208,252,62,null,Dir.UP_RIGHT),b=new GameObj(JQObject.PLATFORM,a.pos.x+a.w-11,a.pos.y-a.h-5,200,62);f=new GameObj(JQObject.DOOR,b.pos.x+b.w-63,b.pos.y-62-Graphics.projectY/2,33,62),level.objs.push(b,a,f),g=new GameItem(new GameObj(JQObject.LADDER,a.pos.x-37,a.pos.y-1,38,FULLH-a.pos.y-game.padFloor),!1,0,!1),g.collidable=!1,level.objs.push(g)}function c(){for(var a=[],b=0;3>b;++b)a.push(new GameItem(new GameObj(JQObject.CRATE,446,FULLH-game.padFloor-26+5,34,37,"crate.png"),!0));a[1].pos.x=i[Dir.LEFT].pos.x+i[Dir.LEFT].w/2-a[0].w/2,a[2].pos.x=i[Dir.RIGHT].pos.x+i[Dir.RIGHT].w/2-a[0].w/2;var c=new GameItem(new GameObj(JQObject.SACK,680,111+Graphics.projectY/2,30,34,"sack.png"),!1,5);e=new GameItem(new GameObj(JQObject.CASH,113,80,22,24,"cash.png"),!1,10,!1),level.items.push(a[0],a[1],a[2],c,e)}function d(){var a=new Enemy(new GameObj(JQObject.ENEMY,1200,FULLH-game.padFloor-55+Graphics.projectY/2,40,55,"cyborgBnW.png"),JQEnemy.FOLLOW,1,1087,1600,!1);a.collidable=!1,level.enemies.push(a)}var e,f,g,h=!1,i={};return{width:2710,init:function(){level.hiddenItems=1,b(),c(),d(),a()},deinit:function(){e=null,f=null,g=null,h=!1},update:function(){if(window.DEBUG&&level.complete(),h?hero.onLadder=SAT.testPolygonPolygon(hero,g):h=Physics.handleScale(),!e.visible)for(var a=0;a<hero.bulletArr.length;++a)Physics.isCollision(hero.bulletArr[a],e,-17)&&(e.visible=!0,audio.discovery.play(),++level.hiddenItemsFound);
!game.over&&Physics.isCollision(hero,f,0)&&level.complete()},render:function(){Graphics.drawScaleBg(i)}}}(),lvl2=function(){function a(){level.bgColor.gradX=p.pos.x,level.bgColor.gradY=p.pos.y,level.bgColor.fillStyle=Graphics.getDoorBgGrad(),Graphics.setClouds(lvl2.width)}function b(){g=new GameObj(JQObject.PLATFORM,-Graphics.projectX,FULLH-game.padFloor,FULLW-250,game.padFloor),h=new GameObj(JQObject.HILL,200,FULLH-game.padFloor,320,60),i=new GameObj(JQObject.PLATFORM,g.pos.x+g.w-Graphics.projectX,g.pos.y-g.h-30,1e3,180),j=new GameObj(JQObject.PLATFORM,i.pos.x+240,i.pos.y-90+Graphics.projectY,100,85),k=new GameObj(JQObject.PLATFORM,i.pos.x+i.w-100,i.pos.y-90+Graphics.projectY,100,85),l=new GameObj(JQObject.PLATFORM,j.pos.x+140,j.pos.y-137,480,30),level.objs.push(i,g,h,j,k,l);for(var a=0;3>a;++a)s[a]=new GameObj(JQObject.ELEVATOR,k.pos.x+237+300*a,k.pos.y-80*a,115,26),s[a].dir=Dir.DOWN,level.objs.push(s[a]);m=new GameObj(JQObject.PLATFORM,s[2].pos.x+s[2].w+120,190,100,FULLH-190),n=new GameObj(JQObject.SLOPE,m.pos.x+m.w-Graphics.projectX,m.pos.y,900,FULLH-190,null,Dir.DOWN_RIGHT);var b=new GameObj(JQObject.PLATFORM,n.pos.x+n.w-Graphics.projectX-1,FULLH-game.padFloor,1e3,game.padFloor);u=Graphics.getScale(b.pos.x+250,FULLH-game.padFloor-137),level.objs.push(u.hBar,u.vBar,u[Dir.LEFT],u[Dir.RIGHT]),o=new GameObj(JQObject.LADDER,b.pos.x+b.w-Graphics.projectX-30,140,30,FULLH-140-game.padFloor),o.visible=!1,o.collidable=!1;var c=new GameObj(JQObject.PLATFORM,o.pos.x+o.w,140,350,game.padFloor);p=new GameObj(JQObject.DOOR,c.pos.x+c.w-90,c.pos.y-100,40,100),level.objs.push(b,n,m,c,p,o)}function c(){var a=new GameItem(new GameObj(JQObject.CRATE,l.pos.x+l.w/2-80,l.pos.y-37,34,37,"crate.png"),!0),b=new GameItem(new GameObj(JQObject.CRATE,l.pos.x+l.w/2+80,l.pos.y-37,34,37,"crate.png"),!0),c=new GameItem(new GameObj(JQObject.SACK,j.pos.x+300,302,30,36,"sack.png"),!0,5);level.items.push(c,a,b)}function d(){var a=new Enemy(new GameObj(JQObject.ENEMY,j.pos.x+j.w,404,40,55,"cyborgBnW.png"),JQEnemy.PATROL,1,j.pos.x+j.w,k.pos.x-27.5,!0);a.collidable=!0,level.enemies.push(a),r=e(),q=new GameObj(JQObject.EMPTY,r.pos.x,r.pos.y,r.w,r.h),q.collidable=!1,q.visible=!1,level.objs.push(q),level.enemies.push(r)}function e(){return en=new Enemy(new GameObj(JQObject.ENEMY,m.pos.x+35,m.pos.y-55,40,55,"cyborgBnW.png"),JQEnemy.STILL,5),en.collidable=!0,en}function f(){if(q.pos.x+q.w>=0&&q.pos.x+q.w<=FULLW){if(v&&(v=!1,r.revive()),r.alive&&null===t){var a;a=hero.pos.x<r.pos.x?Dir.LEFT:Dir.RIGHT,t=new GameObj(JQObject.FIREBALL,r.pos.x,r.pos.y,20,20,null,a),t.tag=level.objs.length,t.collidable=!1,level.objs.push(t)}}else r.alive||(v=!0);null!==t&&(t.dir===Dir.LEFT?--t.pos.x:++t.pos.x,(t.pos.x<=0||t.pos.x>=FULLW)&&(level.objs.splice(t.tag,1),t=null)),!hero.invincible&&null!==t&&SAT.testPolygonPolygon(hero,t)&&(level.objs.splice(t.tag,1),t=null,audio.play(audio.heartbeat,!0),hero.invincible=!0,--hero.health)}var g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=null,u={},v=!1,w=!1;return{width:5030,init:function(){level.hiddenItems=0,b(),c(),d(),a()},deinit:function(){w=!1},update:function(){for(var a=0;a<s.length;++a)s[a].dir===Dir.UP&&s[a].pos.y<100?s[a].dir=Dir.DOWN:s[a].dir===Dir.DOWN&&s[a].pos.y>400&&(s[a].dir=Dir.UP),s[a].vY=s[a].dir===Dir.DOWN?1:-1,s[a].pos.y+=s[a].vY;f(),w?hero.onLadder=SAT.testPolygonPolygon(hero,o):w=Physics.handleScale(),SAT.testPolygonPolygon(hero,p)&&level.complete()},render:function(){Graphics.drawScaleBg(u)}}}();Level3.prototype=function(){function a(){var a=new GameObj(JQObject.FLOOR,-Graphics.projectX,FULLH-game.padFloor,1e3,game.padFloor);level.objs.push(a)}return{width:2400,init:function(){level.hiddenItems=0,a()},deinit:function(){},update:function(){},render:function(){ctx.fillStyle="#fff",ctx.fillText("LEVEL 3 -- COMING SOON",300,300)}}}();var game=function(){function a(){level.isCutscene||level.isTransitioning||game.over||hero.update(),level.update()}function b(a){a-g>0&&(h=a-g),g=a,d=requestAnimFrame(b),level.render(),level.isCutscene||(game.over||hero.render(),HUD.draw(),c())}function c(){if(i.push(1e3/h),game.totalTicks%120===0){for(var a=0,b=i.length;--b;)a+=i[b];for(f=i.length>0?Math.floor(a/i.length):0;i.length>0;)i.pop()}ctx.fillStyle="#ddd",ctx.font="11px 'Press Start 2P'",ctx.fillText(f+" FPS",FULLW-77,FULLH+50)}var d,e,f=0,g=0,h=16,i=[60];return{over:!1,gravity:.13,padHUD:58,padFloor:16,lvl:0,totalTicks:0,actualTime:0,start:function(){e=setInterval(function(){++game.totalTicks,Graphics.ticker+=Graphics.fadeOut?-Graphics.tickerStep:Graphics.tickerStep,a()},8.3333),b()},stop:function(){window.cancelAnimationFrame(d),clearInterval(e)}}}(),Shuriken={w:31,h:31,speed:4.4},hero=function(){function a(){hero.invincible&&--k,0>=k&&(hero.invincible=!1,k=l),hero.health<=0&&!game.over&&utils.deathSequence()}function b(){var a={x:0,y:0};if(hero.isHolding&&0===hero.vX)a=j.playerDown;else if(hero.onLadder)a=j.playerUp;else if(hero.dir===Dir.RIGHT||hero.dir===Dir.LEFT){var b=hero.dir===Dir.RIGHT,c="player"+(b?"Right":"Left");if(b&&hero.vX>0||!b&&hero.vX<0){var d=game.totalTicks%96;hero.isOnObj?Math.abs(hero.vX)<=10*hero.aX?a=j[c+"_Step"]:d>=0&&24>d?(a=j[c+"_Run1"],hero.isJumping||audio.step.play()):d>=24&&48>d?a=j[c+"_Run2"]:d>=48&&72>d?(a=j[c+"_Run3"],hero.isJumping||audio.step.play()):a=j[c+"_Run2"]:a=j[c+"_Run1"]}else a=j[c]}if(hero.onLadder||0!==hero.vX||0!==hero.vY?(hero.idleTime=0,hero.isHolding&&(hero.curItem.pos.y=hero.pos.y+20)):++hero.idleTime,hero.idleTime>210){var e=hero.idleTime%200;e>=0&&50>=e||e>100&&150>=e?a=j.playerDown:e>50&&100>=e?(a=j.playerDown_breatheIn,hero.isHolding&&(hero.curItem.pos.y=hero.pos.y+18)):e>150&&200>=e&&(a=j.playerDown_breatheOut,hero.isHolding&&(hero.curItem.pos.y=hero.pos.y+22))}var f=k%40;hero.invincible&&f>=0&&16>=f&&(a={x:-1,y:-1}),hero.sx=a.x,hero.sy=a.y}function c(){h&&hero.sx>=0&&hero.sy>=0&&ctx.drawImage(i,hero.sx,hero.sy,hero.w,hero.h,Math.round(hero.pos.x),Math.round(hero.pos.y),hero.w,hero.h)}function d(){hero.isHolding&&hero.curItem.draw()}var e=null,f=null,g=null,h=!1,i=null,j=[],k=170,l=170;return{sx:0,sy:0,lvlX:0,w:48,h:65,vX:0,vY:0,aX:.17,aY:.82,jumpMod:4,jumpMod0:4,idleTime:0,dir:Dir.RIGHT,onLadder:!1,invincible:!1,isJumping:!1,isHolding:!1,isOnObj:!0,curItem:null,lives:3,health:3,maxHealth:3,medKits:1,healthLvl:1,mana:0,maxMana:4,manaKits:1,manaLvl:1,ammo:20,cash:0,lvl:1,xp:0,xpNeeded:50,bulletArr:[],init:function(){i=new Image,i.onload=function(){h=!0},i.src="img/sprites/player/player.png",$.get("img/sprites/player/player.xml",function(a){var b=$(a).find("sprite");$(b).each(function(){var a=$(this).attr("n"),b=$(this).attr("x"),c=$(this).attr("y");a=a.substring(0,a.length-4),j[a]={x:b,y:c}})}),e=HeroInputComponent(),g=HeroPhysicsComponent(),f=HeroGraphicsComponent(),$.extend(hero,new SAT.Box(new SAT.Vector(0,0),hero.w,hero.h).toPolygon())},update:function(){e.check(),g.updatePosition(),g.checkCollision(),a(),b()},render:function(){c(),f.drawBullets(),d()},landed:function(a){hero.isOnObj=!0,hero.isJumping=!1,hero.vY=0,hero.pos.y-=a}}}(),HeroGraphicsComponent=function(){var a=!1,b=new Image;return b.src="img/shuriken.png",b.onload=function(){a=!0},{drawBullets:function(){for(var c=0;c<hero.bulletArr.length;++c){var d=hero.bulletArr[c].dirR?hero.w:0;hero.bulletArr[c].deg+=5,a&&Graphics.drawRotate(b,hero.bulletArr[c].pos.x+d,hero.bulletArr[c].pos.y+20,hero.bulletArr[c].deg)}}}},HeroPhysicsComponent=function(){function a(){for(var a=0;a<hero.bulletArr.length;++a)hero.bulletArr[a].pos.x+=hero.bulletArr[a].dirR?Shuriken.speed:-Shuriken.speed,hero.bulletArr[a].pos.x>FULLW||hero.bulletArr[a].pos.x<0?hero.bulletArr.splice(a,1):Physics.testObjObjs(hero.bulletArr[a],function(){hero.bulletArr.splice(a,1)})}function b(){hero.pos.y<2*-hero.h?(hero.pos.y=2*-hero.h,hero.vY=0):hero.pos.y>=FULLH+2*hero.h&&(game.over||utils.deathSequence()),hero.pos.x<0?(hero.pos.x=0,hero.vX=0):hero.pos.x>FULLW-hero.w&&(hero.pos.x=FULLW-hero.w,hero.vX=0)}function c(){hero.isOnObj=!1,Physics.testObjObjs(hero,function(a){var b={x:Dir.NONE,y:Dir.NONE};1===a.overlapN.y?b.y=Dir.TOP:-1===a.overlapN.y&&(b.y=Dir.BOT),1===a.overlapN.x?b.x=Dir.LEFT:-1===a.overlapN.y&&(b.x=Dir.RIGHT),a.b.type===JQObject.SLOPE||a.b.type===JQObject.POLY||a.b.type===JQObject.HILL?hero.vY>=0&&hero.landed(a.overlapV.y):a.b.type===JQObject.ELEVATOR?b.y===Dir.TOP&&hero.vY>=0&&(hero.isOnObj=!0,hero.isJumping=!1,hero.vY=a.b.vY>0?a.b.vY:0,a.a.pos.y-=a.overlapV.y):(a.a.pos.x-=a.overlapV.x,b.y===Dir.TOP&&hero.vY>=0?hero.landed(a.overlapV.y):b.y===Dir.BOT&&hero.vY<=0&&(hero.vY=0,a.a.pos.y-=a.overlapV.y))}),hero.isHolding&&(0===hero.vX?(hero.curItem.pos.x=hero.pos.x+7,hero.curItem.pos.y=hero.pos.y+20):(hero.curItem.pos.x=hero.pos.x+(hero.dir===Dir.RIGHT?45:-32),hero.curItem.pos.y=hero.pos.y+16)),Physics.testHeroItems(function(a,b){a.b.type===JQObject.CRATE?1===a.overlapN.y?(hero.pos.y-=a.overlapV.y,hero.isOnObj=!0,hero.isJumping=!1,hero.vY=0,"undefined"!=typeof a.b.onObj&&null!==a.b.onObj&&a.b.onObj.type===JQObject.ELEVATOR&&(hero.vY=a.b.vY)):hero.isHolding||!a.b.grabbable||a.b.recentlyHeld||(a.b.isOnObj===!0&&(a.b.isOnObj=!1,null!==a.b.onObj&&(a.b.onObj.grabbable=!0,a.b.onObj=null)),a.b.isBeingHeld=!0,hero.curItem=a.b,hero.isHolding=!0,level.items.splice(b,1)):(audio.itemPickedUp.play(),a.b.type===JQObject.SACK?hero.ammo+=a.b.val:a.b.type===JQObject.CASH&&(hero.cash+=a.b.val),level.items.splice(b,1))})}return{updatePosition:function(){if((hero.dir===Dir.RIGHT&&hero.pos.x>=HALFW+35||hero.dir===Dir.LEFT&&hero.pos.x<=HALFW-45)&&hero.lvlX+hero.vX>=0&&hero.lvlX+hero.vX<=level.curLvl.width-FULLW){hero.lvlX+=hero.vX;for(var a=0;a<hero.bulletArr.length;++a)hero.bulletArr[a].pos.x-=hero.vX;level.updateView()}else hero.pos.x+=hero.vX;hero.onLadder||(hero.pos.y+=hero.vY)},checkCollision:function(){a(),b(),c()}}},KeyCode=Object.freeze({ENTER:13,CTRL:17,A:65,D:68,F:70,H:72,J:74,K:75,M:77,O:79,R:82,S:83,W:87,EMPTY:-1,SPACEBAR:32}),HeroInputComponent=function(){var a=3,b=10;return keysDown={},lastKeyDown=-1,$(document).on("click",".resize",function(){$(this).hasClass("off")?($(this).removeClass("off").addClass("on"),$(this).children("span").removeClass("icon-expand").addClass("icon-contract")):$(this).hasClass("on")&&($(this).removeClass("on").addClass("off"),$(this).children("span").removeClass("icon-contract").addClass("icon-expand")),utils.toggleFullScreen()}),addEventListener("keydown",function(a){if(a.keyCode===KeyCode.SPACEBAR)a.preventDefault();else if(a.keyCode===KeyCode.M)audio.handleMuteButton();else if(a.keyCode===KeyCode.F)$(".resize").trigger("click");else if(a.keyCode!==KeyCode.K||hero.isJumping||lastKeyDown===KeyCode.K&&keysDown[KeyCode.K]||!hero.isOnObj){if(a.keyCode!==KeyCode.J||lastKeyDown==KeyCode.J&&keysDown[KeyCode.J])a.keyCode==KeyCode.O&&utils.toggleMenu();else if(hero.ammo>0&&!hero.isHolding){audio.play(audio.effort);var b=new GameObj(JQObject.SHURIKEN,hero.pos.x,hero.pos.y+Shuriken.h/2,Shuriken.w,Shuriken.h);b.dirR=hero.dir===Dir.RIGHT,b.deg=0,hero.bulletArr.push(b),--hero.ammo,hero.idleTime=0}}else audio.jump.play(),hero.vY=0,hero.isJumping=!0,hero.isOnObj=!1;lastKeyDown=a.keyCode,keysDown[a.keyCode]=!0},!1),addEventListener("keyup",function(a){delete keysDown[a.keyCode]},!1),{check:function(){var c=!1;if(hero.isJumping?hero.jumpMod>0?hero.vY-=hero.aY*hero.jumpMod--:c=!0:(hero.jumpMod=hero.jumpMod0,c=!0),c&&!hero.onLadder){var d=hero.vY+2*game.gravity;hero.vY=d>b?b:d}var e=!1;keysDown[KeyCode.A]&&(hero.vX=Math.abs(hero.vX-hero.aX)>a?-a:hero.vX-hero.aX,hero.dir=Dir.LEFT,e=!0),keysDown[KeyCode.D]&&(hero.vX=Math.abs(hero.vX+hero.aX)>a?a:hero.vX+hero.aX,hero.dir=Dir.RIGHT,e=!0),Math.abs(hero.vX)<hero.aX?hero.vX=0:e||(hero.vX/=1.26),keysDown[KeyCode.W]&&hero.onLadder&&--hero.pos.y,keysDown[KeyCode.S]&&hero.onLadder&&++hero.pos.y,keysDown[KeyCode.SPACEBAR]&&hero.isHolding&&(hero.isHolding=!1,hero.curItem.isBeingHeld=!1,hero.curItem.recentlyHeld=!0,level.items.push(hero.curItem),hero.curItem=null),keysDown[KeyCode.H]&&hero.medKits>0&&hero.health<hero.maxHealth&&(++hero.health,--hero.medKits,audio.play(audio.enchant,!0)),keysDown[KeyCode.R]&&!keysDown[KeyCode.CTRL]&&hero.manaKits>0&&hero.mana<hero.maxMana&&(++hero.mana,--hero.manaKits,audio.play(audio.enchant,!0))}}},Main=function(){function a(){canvas=$("canvas")[0],ctx=canvas.getContext("2d"),FULLW=canvas.width,FULLH=canvas.height-game.padHUD,HALFW=FULLW/2,HALFH=FULLH/2}function b(){ctx.fillStyle="#e1e1e1",ctx.font="25px 'Press Start 2P'",ctx.fillText("LOADING...",HALFW-80,HALFH+20)}return{init:function(){a(),b(),hero.init(),audio.init(),level.init(),HUD.init(),$(document).on("fontLoaded",function(){setInterval(function(){++game.actualTime},1e3),game.start()})}}}();$(function(){window.WebFontConfig={google:{families:["Press Start 2P"]},active:function(){$(document).trigger("fontLoaded")},inactive:function(){alert("There was a problem loading a font from google, some text may not render correctly (refreshing the page may fix the issue)."),$(document).trigger("fontLoaded")}},function(){var a=document.createElement("script");a.src="//ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",a.type="text/javascript",a.async="true";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}(),Main.init()});